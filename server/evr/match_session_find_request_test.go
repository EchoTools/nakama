package evr

import (
	"testing"

	"github.com/gofrs/uuid/v5"
	"github.com/google/go-cmp/cmp"
)

func TestLobbyFindSessionRequest_UnmarshalJSON(t *testing.T) {
	testCases := []struct {
		name string
		data []byte
		want *LobbyFindSessionRequest
	}{
		{
			name: "Press `Play` on the main menu",
			data: []byte{
				0x0d, 0x91, 0x77, 0x8f, 0xd7, 0x01, 0x2f, 0xc6, // Version Lock
				0x76, 0xcf, 0xdd, 0xcf, 0xf9, 0x9c, 0x2d, 0x04, // Mode
				0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, // Level
				0xf8, 0xf4, 0x9f, 0xa8, 0xb1, 0xd0, 0xe8, 0xc8, // Platform
				0x1f, 0xac, 0x51, 0x12, 0xbc, 0x11, 0xef, 0x11, 0x93, 0x1a, 0x66, 0xd3, 0xff, 0x8a, 0x65, 0x3b, // Session ID
				0x01, 0x02, 0x00, 0x00, // Flags
				0x00, 0x00, 0x00, 0x00,
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // Current Session
				0xd8, 0x47, 0x74, 0x2e, 0xe2, 0x4c, 0x71, 0x48, 0x9e, 0x4b, 0x13, 0xa4, 0x7a, 0x5a, 0x6f, 0xa6, // Channel
				0x7b, 0x22, 0x67, 0x61, 0x6d, 0x65, 0x74, 0x79, 0x70, 0x65, 0x22, 0x3a, 0x33, 0x30, 0x31, 0x30, // Session Settings (JSON)...
				0x36, 0x39, 0x33, 0x34, 0x36, 0x38, 0x35, 0x31, 0x39, 0x30, 0x31, 0x33, 0x30, 0x32, 0x2c, 0x22,
				0x61, 0x70, 0x70, 0x69, 0x64, 0x22, 0x3a, 0x22, 0x31, 0x33, 0x36, 0x39, 0x30, 0x37, 0x38, 0x34,
				0x30, 0x39, 0x38, 0x37, 0x33, 0x34, 0x30, 0x32, 0x22, 0x7d,
				0x00,                                                                                           // Null terminator
				0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x16, 0xa9, 0x53, 0x29, 0xef, 0x14, 0x0e, 0x00, // Entrant 0 EvrID

			},
			want: &LobbyFindSessionRequest{
				VersionLock:      0xc62f01d78f77910d,
				Mode:             ModeSocialPublic,
				Level:            LevelUnspecified,
				Platform:         ToSymbol("OVR"),
				CrossPlayEnabled: true,
				LoginSessionID:   uuid.FromStringOrNil("1251ac1f11bc11ef931a66d3ff8a653b"),
				GroupID:          uuid.UUID{0x2e, 0x74, 0x47, 0xd8, 0x4c, 0xe2, 0x48, 0x71, 0x9e, 0x4b, 0x13, 0xa4, 0x7a, 0x5a, 0x6f, 0xa6},
				SessionSettings: LobbySessionSettings{
					AppID: "1369078409873402",
					Mode:  int64(ModeSocialPublic),
					Level: int64(LevelUnspecified),
				},
				Entrants: []Entrant{
					{
						EvrID: EvrId{
							PlatformCode: 4,
							AccountId:    3963667097037078,
						},
						Role: int8(TeamUnassigned),
					},
				},
			},
		},
		{
			name: "Press `Find Match` on the lobby Terminal",
			data: []byte{
				0x0d, 0x91, 0x77, 0x8f, 0xd7, 0x01, 0x2f, 0xc6, // Version Lock
				0x76, 0xcf, 0xdd, 0xcf, 0xf9, 0x9c, 0x2d, 0x04, // Mode
				0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, // Level
				0xf8, 0xf4, 0x9f, 0xa8, 0xb1, 0xd0, 0xe8, 0xc8, // Platform
				0x31, 0x4e, 0x3d, 0x55, 0xb2, 0x11, 0xef, 0x11, 0x93, 0x1a, 0x66, 0xd3, 0xff, 0x8a, 0x65, 0x3b, // Session ID
				0x01, 0x02, 0x00, 0x00, // Flags
				0x00, 0x00, 0x00, 0x00, // Skipped
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // Current Session
				0xd8, 0x47, 0x74, 0x2e, 0xe2, 0x4c, 0x71, 0x48, 0x9e, 0x4b, 0x13, 0xa4, 0x7a, 0x5a, 0x6f, 0xa6, // Channel
				0x7b, 0x22, 0x67, 0x61, 0x6d, 0x65, 0x74, 0x79, 0x70, 0x65, 0x22, 0x3a, 0x33, 0x30, 0x31, 0x30, // Session Settings (JSON)...
				0x36, 0x39, 0x33, 0x34, 0x36, 0x38, 0x35, 0x31, 0x39, 0x30, 0x31, 0x33, 0x30, 0x32, 0x2c, 0x22,
				0x61, 0x70, 0x70, 0x69, 0x64, 0x22, 0x3a, 0x22, 0x31, 0x33, 0x36, 0x39, 0x30, 0x37, 0x38, 0x34,
				0x30, 0x39, 0x38, 0x37, 0x33, 0x34, 0x30, 0x32, 0x22, 0x7d, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00,
				0x00, 0x00, 0x00, 0x16, 0xa9, 0x53, 0x29, 0xef, 0x14, 0x0e, 0x00,
			},
			want: &LobbyFindSessionRequest{
				VersionLock:      0xc62f01d78f77910d,
				Mode:             ModeSocialPublic,
				Level:            LevelUnspecified,
				Platform:         ToSymbol("OVR"),
				CrossPlayEnabled: true,
				LoginSessionID:   uuid.FromStringOrNil("553d4e3111b211ef931a66d3ff8a653b"),
				GroupID:          uuid.UUID{0x2e, 0x74, 0x47, 0xd8, 0x4c, 0xe2, 0x48, 0x71, 0x9e, 0x4b, 0x13, 0xa4, 0x7a, 0x5a, 0x6f, 0xa6},
				SessionSettings: LobbySessionSettings{
					AppID: "1369078409873402",
					Mode:  301069346851901302,
					Level: int64(LevelUnspecified),
				},
				Entrants: []Entrant{
					{
						EvrID: EvrId{
							PlatformCode: 4,
							AccountId:    3963667097037078,
						},
						Role: int8(TeamUnassigned),
					},
				},
			},
		},
		{
			name: "Unknown",
			data: []byte{
				0x0d, 0x91, 0x77, 0x8f, 0xd7, 0x01, 0x2f, 0xc6,
				0x73, 0xaf, 0x1c, 0x7e, 0xde, 0xa4, 0x60, 0xcb,
				0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
				0xe5, 0xef, 0x94, 0xa8, 0xb1, 0xd0, 0xe8, 0xc8,
				0xf0, 0x3c, 0x22, 0x0a, 0x73, 0x8b, 0xfa, 0x3d,
				0x2e, 0xe8, 0x77, 0x74, 0xc3, 0xb2, 0x80, 0x97,
				0x01, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				0x7b, 0x22, 0x67, 0x61, 0x6d, 0x65, 0x74, 0x79,
				0x70, 0x65, 0x22, 0x3a, 0x2d, 0x33, 0x37, 0x39,
				0x31, 0x38, 0x34, 0x39, 0x36, 0x31, 0x30, 0x37,
				0x34, 0x30, 0x34, 0x35, 0x33, 0x35, 0x31, 0x37,
				0x2c, 0x22, 0x61, 0x70, 0x70, 0x69, 0x64, 0x22,
				0x3a, 0x22, 0x31, 0x33, 0x36, 0x39, 0x30, 0x37,
				0x38, 0x34, 0x30, 0x39, 0x38, 0x37, 0x33, 0x34,
				0x30, 0x32, 0x22, 0x7d, 0x00, 0x07, 0x00, 0x00,
				0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x87, 0x51,
				0xfd, 0x39, 0x7e, 0x1c, 0x77, 0x02, 0x00,
			},
			want: &LobbyFindSessionRequest{
				VersionLock:      0xc62f01d78f77910d,
				Mode:             ModeArenaPublic,
				Level:            0xffffffffffffffff,
				Platform:         ToSymbol("DMO"),
				CrossPlayEnabled: true,
				LoginSessionID:   uuid.UUID{0x0a, 0x22, 0x3c, 0xf0, 0x8b, 0x73, 0x3d, 0xfa, 0x2e, 0xe8, 0x77, 0x74, 0xc3, 0xb2, 0x80, 0x97},
				GroupID:          uuid.UUID{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
				SessionSettings: LobbySessionSettings{
					AppID: "1369078409873402",
					Mode:  -3791849610740453517,
					Level: int64(LevelUnspecified),
				},
				Entrants: []Entrant{
					{
						EvrID: EvrId{
							PlatformCode: 7,
							AccountId:    8582873777389537089,
						},
						Role: 2,
					},
				},
			},
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			data, _ := WrapBytes(SymbolOf(&LobbyFindSessionRequest{}), tc.data)

			messages, err := ParsePacket(data)
			if err != nil {
				t.Fatalf(err.Error())
			}

			if diff := cmp.Diff(tc.want, messages[0]); diff != "" {
				t.Errorf("unexpected LobbyFindSessionRequest (-want +got):\n%s", diff)
			}
		})
	}

}
